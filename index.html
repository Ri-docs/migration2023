<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RapidIdentity On-Prem Migration Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 antialiased">
    <header class="bg-sky-700 text-white shadow">
      <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-6">
        <h1 class="text-2xl font-semibold tracking-wide">
          RapidIdentity Migration Cheat Sheet
        </h1>
        <nav class="hidden md:flex space-x-6 text-sm font-medium">
          <a href="#pre" class="hover:underline">Pre‑Migration</a>
          <a href="#planning" class="hover:underline">Planning</a>
          <a href="#execution" class="hover:underline">Live&nbsp;Execution</a>
          <a href="#validation" class="hover:underline">Validation</a>
          <a href="#troubleshooting" class="hover:underline">Troubleshooting</a>
        </nav>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12 space-y-20">
      <section id="pre" class="space-y-6">
        <div class="rounded-lg border border-amber-300 bg-amber-50 p-4 text-amber-800">
          <p class="font-semibold">Mandatory</p>
          <p>Run the DB Fix script on the <strong>new DB</strong> before <em>any</em> download or curl. The CLI can show “DB running” when Postgres isn’t installed. Do not proceed until this script completes.</p>
        </div>

        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">0.</span> Pre‑Migration
        </h2>
        <ul class="list-disc list-inside space-y-2">
          <li>Create new VMs for ARMS, DSS, and DB using the RI ISO. During install choose “Other versions” and select the exact production build. Assign temporary IPs to each new VM.</li>
          <li>Old and new appliances must run the same <strong>RI build</strong> before migration.</li>
          <li>Create snapshots of every old VM (rollback points).</li>
          <li>Gather admin credentials, DB password, and vault secrets.</li>
          <li>Record current IPs, masks (usually <code>/24</code>; appliance defaults to <code>/8</code>), hostnames, gateways.</li>
          <li>Prepare an old→new server mapping list with hostnames and IPs.</li>
          <li>Determine the DB version (on the DB host):
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"</code></pre>
          </li>
        </ul>

        <details class="group border border-red-200 rounded-lg">
          <summary class="cursor-pointer select-none px-3 py-2 font-medium text-red-700">DB Fix script (run first on NEW DB, before any curl)</summary>
          <div class="px-3 pb-3 mt-2">
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>#!/bin/bash
echo "Updating Mysql gpg key"
rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
echo "Updating PostgreSQL gpg key"
/bin/yum --disablerep=* -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
/bin/yum updateinfo -y
/root/ApplianceSetupScript.sh
echo "Updating PostgreSQL appliance menus"
cd /var/opt/idauto/menu/2020.0
mv menu.sh menu.bak
cat menu.bak | sed '/9/s//15/g' > menu.sh
chown root.idauto menu.sh
chmod 550 menu.sh
cd /var/opt/idauto/admin/2020.0/scripts/config/
mv installPostgreSQL.sh installPostgreSQL.bak
cat installPostgreSQL.bak | sed '/9/s//15/g' > installPostgreSQL.sh
chown root.idauto installPostgreSQL.sh
chmod 550 installPostgreSQL.sh
mv uninstallPostgreSQL.sh uninstallPostgreSQL.bak
cat uninstallPostgreSQL.bak | sed '/9/s//15/g' > uninstallPostgreSQL.sh
chown root.idauto uninstallPostgreSQL.sh
chmod 550 uninstallPostgreSQL.sh
mv serviceCmd.sh serviceCmd.bak
cat serviceCmd.bak | sed '/9/s//15/g' > serviceCmd.sh
chown root.idauto serviceCmd.sh
chmod 550 serviceCmd.sh</code></pre>
            <div class="mt-2 text-sm text-gray-700">
              <p>Save as <code>/root/db-fix.sh</code>, then run:</p>
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>chmod +x /root/db-fix.sh
/root/db-fix.sh</code></pre>
            </div>
          </div>
        </details>
      </section>

      <section id="planning" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">1.</span> Planning
        </h2>
        <ol class="list-decimal list-inside space-y-4 pl-4">
          <li>
            <p class="font-medium">High‑Level Flow</p>
            <p>Version parity → stop RI on old appliances (during cutover) → network on new appliances (temp IPs) → <strong>DB Fix on new DB</strong> → <strong>AWS script migration</strong> → file‑store copy (if needed) → cutover (re‑IP) → validation → upgrade to latest LTS.</p>
          </li>
          <li>
            <p class="font-medium">Roles/Capabilities</p>
            <p>With the script path, roles and most settings clone over automatically. Minimal manual alignment expected.</p>
          </li>
          <li>
            <p class="font-medium">Network & Firewall</p>
            <p>Ensure routing and required traffic (e.g., <code>5432/tcp</code>). Correct masks off the default <code>/8</code> if not intended.</p>
          </li>
        </ol>
      </section>

      <section id="execution" class="space-y-10">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">2.</span> Live Execution (Script‑First)
        </h2>

        <div class="rounded-lg border border-amber-300 bg-amber-50 p-4 text-amber-800">
          <p class="font-medium">Order matters</p>
          <p>Run the <strong>DB Fix</strong> on the new DB first. Then use the AWS migration script below. This path automates ~99% (settings, DB, services) and typically avoids schema issues.</p>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.1 Migration using AWS script (Primary)</h3>
          <ol class="list-decimal list-inside space-y-3 pl-4">
            <li>On the <strong>new DB</strong>, download & unpack:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>cd /root
curl https://idauto-apps.s3.amazonaws.com/appliance-migrate/migrate-appliance.tar.gz | tar xvz</code></pre>
            </li>
            <li>Migrate DB from the <strong>old DB</strong> to the <strong>new DB</strong>:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-DB-IP&gt; --target-db-host=localhost --migrate-db</code></pre>
            </li>
            <li>Migrate ARMS/DSS to their new appliances:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-ARMS-IP&gt;
./migrate-appliance.sh --src-host=&lt;OLD-DSS-IP&gt;</code></pre>
              <p class="text-sm text-gray-600">Ensure <code>/etc/hosts</code> on each new appliance maps <code>idautodb</code> → new DB IP.</p>
            </li>
            <li>Verify service health locally:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>pg_isready -h 127.0.0.1 -p 5432
psql idautodb idautoAdmin -t -A -c "select 1"</code></pre>
            </li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.2 File‑Store (if not handled)</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>Old path: Config → General → Settings → File Storage.</li>
            <li>New path: VM console Main Menu 6 → Connection Info.</li>
            <li>Copy old → new and confirm the new UI points to the new share.</li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.3 Cutover</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>Shutdown order for old: ARMS → DSS → DB.</li>
            <li>Re‑IP the new appliances to production (or update DNS).</li>
            <li>Boot order for new: DB → DSS → ARMS/Portal.</li>
          </ol>
        </div>

        <details class="group border border-gray-200 rounded-lg">
          <summary class="cursor-pointer select-none px-3 py-2 font-medium text-sky-700">Alternative: UI‑driven migration</summary>
          <div class="px-3 pb-3 mt-2 space-y-4">
            <ol class="list-decimal list-inside space-y-3 pl-4">
              <li>Portal → Config → Systems → Migrate Database → Add Source (old DB).</li>
              <li>Get DB password from Status → Advanced → rapidIdentity.properties.</li>
              <li>Select all modules except <em>Audit</em>; start migration.</li>
              <li>If “schema mismatch” appears, export <em>Database Configuration Tables</em> on old, place on new as <code>/var/sftp/files/configdb.sql</code>, then:
                <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin &lt; /var/sftp/files/configdb.sql
sudo systemctl restart ri.service</code></pre>
              </li>
            </ol>
          </div>
        </details>
      </section>

      <section id="validation" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">3.</span> Validation
        </h2>
        <ol class="list-decimal list-inside space-y-2 pl-4">
          <li>Portal & Connect login works.</li>
          <li>Representative workflows (actionsets) run successfully.</li>
          <li>ARMS and DSS reachable over HTTPS; logs clean.</li>
          <li>DNS or production IPs correct and reachable; retire old VMs.</li>
        </ol>
      </section>

      <section id="troubleshooting" class="space-y-6 pb-16">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">4.</span> Troubleshooting & Quick Commands
        </h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h3 class="font-semibold mb-2">Common Issues</h3>
            <ul class="list-disc list-inside space-y-2">
              <li>DB “running” in CLI but PG not installed → run the <strong>DB Fix</strong> first, then re‑run the migration script.</li>
              <li>Schema mismatch (UI path) → config schema export/import on new DB; script path usually avoids this.</li>
              <li>Routing/mask issues → correct default <code>/8</code> to intended <code>/24</code>.</li>
              <li>Port 5432 blocked → verify with <code>pg_isready</code> or local <code>psql</code>.</li>
              <li>SSO loops → disable SSO temporarily; restart RI.</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Cheat‑Sheet</h3>
            <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>sudo systemctl restart ri.service
pg_isready -h 127.0.0.1 -p 5432
psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"
psql idautodb idautoAdmin -t -A -c "select 1"</code></pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-sky-700 text-white text-sm py-4">
      <div class="max-w-7xl mx-auto px-4 text-center">
        RapidIdentity Migration Guide
      </div>
    </footer>
  </body>
</html>
