<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RapidIdentity On-Prem Migration Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 antialiased">
    <header class="bg-sky-700 text-white shadow">
      <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-6">
        <h1 class="text-2xl font-semibold tracking-wide">
          RapidIdentity Migration Cheat Sheet
        </h1>
        <nav class="hidden md:flex space-x-6 text-sm font-medium">
          <a href="#pre" class="hover:underline">Pre-Migration</a>
          <a href="#planning" class="hover:underline">Planning</a>
          <a href="#execution" class="hover:underline">Live&nbsp;Execution</a>
          <a href="#lessons" class="hover:underline">Lessons&nbsp;Learned</a>
          <a href="#alternate" class="hover:underline">JP&nbsp;Script&nbsp;Method</a>
          <a href="#validation" class="hover:underline">Validation</a>
          <a href="#troubleshooting" class="hover:underline">Troubleshooting</a>
        </nav>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12 space-y-20">
      <section id="pre" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">0.</span> Pre-Migration
        </h2>
        <ul class="list-disc list-inside space-y-2">
          <li>Create new VMs for ARMS, DSS, and DB using the RI ISO. During install choose "Other versions" and select the exact production build. Assign temporary IPs to each new VM.</li>
          <li>All old and new VMs must run the same RapidIdentity build.</li>
          <li>Create snapshots of every old VM. These are your rollback points.</li>
          <li>Gather admin credentials, DB password, and vault secrets.</li>
          <li>Record current IPs, subnets (usually <code>/24</code>; appliance defaults to <code>/8</code>), hostnames, and gateways.</li>
          <li>Prepare an old-to-new server mapping list with hostnames and IPs.</li>
          <li>Plan to apply the required DB prerequisite on the new DB. It is required with the current ISO.</li>
          <li>Determine the production DB version:
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"</code></pre>
            <span class="text-sm text-gray-600">Remote example:</span>
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>PGPASSWORD='&lt;dbPassword&gt;' psql -h &lt;OLD-DB-IP&gt; -p 5432 -U idautoAdmin -d idautodb -t -A -c "show server_version; show server_version_num;"</code></pre>
          </li>
        </ul>
      </section>

      <section id="planning" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">1.</span> Planning
        </h2>
        <ol class="list-decimal list-inside space-y-4 pl-4">
          <li>
            <p class="font-medium">High-Level Flow</p>
            <p>Version parity → DB prerequisite on new DB → Legacy schema remediation (if needed) → DB migration → File-store migration → Cutover (re-IP) → Validation → Upgrade to latest LTS.</p>
          </li>
          <li>
            <p class="font-medium">Version and Role Alignment</p>
            <p>Confirm builds and replicate appliance roles/capabilities from old to new.</p>
          </li>
          <li>
            <p class="font-medium">Network and Firewall Snapshot</p>
            <p>Document rules and verify required traffic, including <code>5432/tcp</code>.</p>
          </li>
          <li>
            <p class="font-medium">Hosts-File Strategy</p>
            <p>If the old DB used <code>/etc/hosts</code> for <code>idautodb</code>, mirror on the new DB pointing to itself.</p>
          </li>
        </ol>
      </section>

      <section id="execution" class="space-y-10">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">2.</span> Live Execution
        </h2>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.1 DB Version Check and Service State</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>On the new DB, check the installed Postgres version:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"</code></pre>
            </li>
            <li>Stop the RI application service on the new DB using the appliance menu.</li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.2 Apply the DB Prerequisite (Required: Upgrade to PG15 on New DB)</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>Get the DB password: Rapididentity → Advanced → Edit <code>rapididentity.properties</code> → <code>db.password</code>.</li>
            <li>Enter Tech Mode and run:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>sh /var/opt/idauto/admin/2024.1/scripts/config/upgradePostgresql.sh '&lt;installed_pg_major&gt;' '&lt;dbPassword&gt;'</code></pre>
            </li>
            <li>If you see GPG/repo errors, refresh the PGDG repo and rerun:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>/bin/yum --disablerep=* -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
/bin/yum updateinfo -y</code></pre>
            </li>
            <li>Start the RI service again and confirm port 5432 is reachable from other nodes.</li>
          </ol>
          <p class="text-sm text-red-700 font-medium">Deprecated: Do not use the legacy menu-edit script that swapped PG11→PG12; it is no longer required and may break current appliances.</p>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.3 Legacy Schema Remediation (Old DBs)</h3>
          <p>Run this if the production environment is older (for example 2019.x) or the migration wizard reports a schema mismatch.</p>
          <ol class="list-decimal list-inside space-y-3 pl-4">
            <li>Export <code>configdb.sql</code> from the old environment (file-system export places it at <code>/var/sftp/files/configdb.sql</code>).</li>
            <li>Place the file on the new DB at <code>/var/sftp/files/configdb.sql</code>.</li>
            <li>Import on the new DB:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin &lt; /var/sftp/files/configdb.sql</code></pre>
            </li>
            <li>Restart RI on the new DB:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>sudo systemctl restart ri.service</code></pre>
            </li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.4 Database Migration (UI-driven)</h3>
          <ol class="list-decimal list-inside space-y-3 pl-4">
            <li>Log in to Portal as <code>idauto::admin / idautoAdmin</code>.</li>
            <li>Snapshot the old DB VM.</li>
            <li>Portal → <strong>Config → Systems → Migrate Database → Add Source</strong> and point to the old DB.</li>
            <li>Get the DB password from <strong>Status → Advanced (7) → rapidIdentity.properties → Option 4</strong>.</li>
            <li>Select all modules except <em>Audit</em> and start the migration.</li>
            <li>If errors occur:
              <ul class="list-disc list-inside ml-4 space-y-1">
                <li>Verify subnet mask (<code>/24</code> vs default <code>/8</code>).</li>
                <li>If “schema mismatch,” repeat Legacy Schema Remediation and retry.</li>
              </ul>
            </li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.5 File-Store Migration (CIFS)</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>Old path: <strong>Config → General → Settings → File Storage</strong>.</li>
            <li>New path: VM console <strong>Main Menu 6 → Connection Info</strong>.</li>
            <li>Copy old → new and point the new UI at the new share.</li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.6 Cut-Over (Re-IP or DNS)</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>Preferred: re-IP the new appliances to production IPs. Alternative: update DNS.</li>
            <li>Shutdown order for old: ARMS → DSS → DB.</li>
            <li>Boot order for new: DB → DSS → ARMS/Portal.</li>
          </ol>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.7 Upgrade to Latest LTS</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>After cutover validation, upgrade to the latest LTS.</li>
            <li>Re-run validation checks in section 5.</li>
          </ol>
        </div>
      </section>

      <section id="lessons" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">3.</span> Lessons Learned (Real-Time Session)
        </h2>
        <ul class="list-disc list-inside space-y-2">
          <li>The UI can appear healthy while DB is down. Start DB first when testing.</li>
          <li>Replicate roles/capabilities early to avoid UI 500s.</li>
          <li>Default <code>/8</code> masks break routing in most on‑prem networks; prefer <code>/24</code>.</li>
          <li>Open <code>5432/tcp</code> between nodes and verify with <code>nmap</code> or <code>telnet</code>.</li>
          <li>Old DBs often trigger schema mismatches; run Legacy Schema Remediation.</li>
          <li>After copying the file store, ensure the new appliances point to the new share.</li>
          <li>Disable SSO temporarily if login loops occur after cutover.</li>
        </ul>
      </section>

      <section id="alternate" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">4.</span> Alternate Migration (JP Script)</h2>
        <p class="mb-4">JP's <code>migrate-appliance.sh</code> can migrate data without the UI. The DB prerequisite on the new DB is still required with the current ISO. The legacy menu-edit script that swapped PG11→PG12 is deprecated and should not be used.</p>
        <ol class="list-decimal list-inside space-y-4 pl-4">
          <li>
            <p class="font-medium">Download and Unpack</p>
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>cd /root
curl https://idauto-apps.s3.amazonaws.com/appliance-migrate/migrate-appliance.tar.gz | tar xvz</code></pre>
          </li>
          <li>
            <p class="font-medium">Run on the New DB</p>
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-DB-IP&gt; \
  --target-db-host=localhost \
  --migrate-db</code></pre>
          </li>
          <li>
            <p class="font-medium">Run on Other Appliances</p>
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-ARMS-IP&gt;</code></pre>
            <p>Ensure <code>/etc/hosts</code> on each new appliance points <code>idautodb</code> to the new DB IP.</p>
          </li>
          <li>
            <p class="font-medium">Re-IP and Start Sequence</p>
            <ol class="list-decimal list-inside pl-4 space-y-1">
              <li>Shut down old appliances (ARMS → DSS → DB).</li>
              <li>Assign production IPs to the new appliances or update DNS.</li>
              <li>Boot order: DB → DSS → ARMS → Portal.</li>
            </ol>
          </li>
        </ol>
      </section>

      <section id="validation" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">5.</span> Validation
        </h2>
        <ol class="list-decimal list-inside space-y-2 pl-4">
          <li>Load Portal and Connect. Verify login and representative workflows.</li>
          <li>Monitor logs on all new nodes for errors.</li>
          <li>Confirm DNS or production IPs are correct and reachable. Retire old VMs.</li>
          <li>After upgrading to the latest LTS, re-run these checks.</li>
        </ol>
      </section>

      <section id="troubleshooting" class="space-y-6 pb-16">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">6.</span> Troubleshooting and Quick Commands
        </h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h3 class="font-semibold mb-2">Common Issues</h3>
            <ul class="list-disc list-inside space-y-2">
              <li>DB won't start; retrieve the password from <code>rapidIdentity.properties</code>.</li>
              <li>Portal 404/500; DB down or hosts file mis-pointed.</li>
              <li>Schema mismatch; run Legacy Schema Remediation, then retry migration.</li>
              <li>Port 5432 blocked; open the firewall and verify.</li>
              <li>SSO loops; disable SSO temporarily and restart RI.</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Cheat-Sheet Commands</h3>
            <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>sudo systemctl restart ri.service
nmap -p 5432 &lt;DB-IP&gt;
psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"
psql idautodb idautoAdmin &lt; /var/sftp/files/configdb.sql</code></pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-sky-700 text-white text-sm py-4">
      <div class="max-w-7xl mx-auto px-4 text-center">
        RapidIdentity Migration Guide
      </div>
    </footer>
  </body>
</html>
