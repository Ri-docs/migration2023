<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RapidIdentity On-Prem Migration Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-800 antialiased">
    <header class="bg-sky-700 text-white shadow">
      <div class="max-w-7xl mx-auto flex items-center justify-between px-4 py-6">
        <h1 class="text-2xl font-semibold tracking-wide">
          RapidIdentity Migration Cheat Sheet
        </h1>
        <nav class="hidden md:flex space-x-6 text-sm font-medium">
          <a href="#pre" class="hover:underline">Pre Migration</a>
          <a href="#planning" class="hover:underline">Planning</a>
          <a href="#migration" class="hover:underline">Migration</a>
          <a href="#validation" class="hover:underline">Validation</a>
          <a href="#troubleshooting" class="hover:underline">Troubleshooting</a>
        </nav>
      </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-12 space-y-20">
      <section id="pre" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">0.</span> Pre Migration
        </h2>
        <ul class="list-disc list-inside space-y-2">
          <li>
            Send the ISO link to the customer and ask them to build new ARMS, DSS, and DB VMs using the same RI build as production.
            <a class="text-sky-700 underline" href="https://idauto.rapididentity.com/ui/files/59d8e000-385d-41b4-88b7-d7887455f79e" target="_blank" rel="noopener">Get the latest ISO</a>
            It is under the folder named Appliances.
          </li>
          <li>Create new VMs for ARMS, DSS, and DB. During install choose Other versions and select the exact production build. Assign temporary IPs.</li>
          <li>Old and new appliances must run the same RI build before migration.</li>
          <li>Create snapshots of every old VM.</li>
          <li>Gather admin credentials, DB password, and any vault secrets.</li>
          <li>Record current IPs, masks, hostnames, and gateways.</li>
          <li>Prepare an old to new server mapping list with hostnames and IPs.</li>
          <li>Determine the DB version on the DB host:
            <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"</code></pre>
          </li>
        </ul>
      </section>

      <section id="planning" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">1.</span> Planning
        </h2>
        <ol class="list-decimal list-inside space-y-4 pl-4">
          <li>High level flow: version parity, network on new appliances with temp IPs, stop RI on old appliances, update hosts file, DB Fix on new DB, migration by script, install file server, transfer IPs, validation, snapshots, upgrades.</li>
          <li>With the script path, roles and most settings clone over automatically.</li>
        </ol>
      </section>

      <section id="migration" class="space-y-10">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">2.</span> Migration
        </h2>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.1 Stop RI on old appliances</h3>
          <p>Stop RI on old ARMS, DSS, and DB.</p>
          <p>This can be done with the first option in the CLI interface or by running this command:</p>
          <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>service rapididentity stop</code></pre>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.2 Hosts file on all new appliances</h3>
          <p>Add this line on all three new appliances before the DB Fix and migration.</p>
          <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>&lt;new-db-ip&gt; idautodb</code></pre>
          <p class="text-sm text-gray-700">After Transfer IPs update the same line to map idautodb to the production DB ip (the old DB ip).</p>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.3 Download bundle and migrate</h3>
          <p>Run these two lines on all three new appliances.</p>
          <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>cd /root
curl https://idauto-apps.s3.amazonaws.com/appliance-migrate/migrate-appliance.tar.gz | tar xvz</code></pre>
          <ol class="list-decimal list-inside space-y-3 pl-4">
            <li>Run the DB Fix on the new DB.</li>
          </ol>

          <details class="group border border-gray-200 rounded-lg">
            <summary class="cursor-pointer select-none px-3 py-2 font-medium text-sky-700">Show DB Fix script</summary>
            <div class="px-3 pb-3 mt-2">
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>#!/bin/bash
echo "Updating Mysql gpg key"
rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2023
echo "Updating PostgreSQL gpg key"
/bin/yum --disablerep=* -y install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
/bin/yum updateinfo -y
/root/ApplianceSetupScript.sh
echo "Updating PostgreSQL appliance menus"
cd /var/opt/idauto/menu/2020.0
mv menu.sh menu.bak
cat menu.bak | sed '/11/s//15/g' > menu.sh
chown root.idauto menu.sh
chmod 550 menu.sh
cd /var/opt/idauto/admin/2020.0/scripts/config/
mv installPostgreSQL.sh installPostgreSQL.bak
cat installPostgreSQL.bak | sed '/11/s//15/g' > installPostgreSQL.sh
chown root.idauto installPostgreSQL.sh
chmod 550 installPostgreSQL.sh
mv uninstallPostgreSQL.sh uninstallPostgreSQL.bak
cat uninstallPostgreSQL.bak | sed '/11/s//15/g' > uninstallPostgreSQL.sh
chown root.idauto uninstallPostgreSQL.sh
chmod 550 uninstallPostgreSQL.sh
mv serviceCmd.sh serviceCmd.bak
cat serviceCmd.bak | sed '/11/s//15/g' > serviceCmd.sh
chown root.idauto serviceCmd.sh
chmod 550 serviceCmd.sh</code></pre>
              <p class="text-sm text-gray-700 mt-2">If PG major in a fresh sandbox is newer than 15 replace 15 with the newer major such as 16.</p>
            </div>
          </details>

          <ol class="list-decimal list-inside space-y-3 pl-4">
            <li>On the new DB:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-DB-IP&gt; --target-db-host=localhost --migrate-db</code></pre>
            </li>
            <li>On the new ARMS:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-ARMS-IP&gt; --target-db-host=idautodb --migrate-db</code></pre>
            </li>
            <li>On the new DSS:
              <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>./migrate-appliance.sh --src-host=&lt;OLD-DSS-IP&gt; --target-db-host=idautodb --migrate-db</code></pre>
            </li>
            <li class="text-sm text-gray-700">Ensure each new appliance has a hosts entry mapping idautodb to the new DB ip before running these.</li>
          </ol>

          <details class="group border border-gray-200 rounded-lg">
            <summary class="cursor-pointer select-none px-3 py-2 font-medium text-sky-700">Alternative migration by UI</summary>
            <div class="px-3 pb-3 mt-2 space-y-4">
              <ol class="list-decimal list-inside space-y-3 pl-4">
                <li>Open Portal and sign in as idauto::admin.</li>
                <li>Go to Configuration > Systems > Migrate Database > Add Source and point to the old DB.</li>
                <li>Get the DB password from Status > Advanced > rapidIdentity.properties.</li>
                <li>Select all modules except Audit and start the migration.</li>
                <li>If a schema mismatch appears export Database Configuration Tables on old, place the file on new at
                  <code>/var/sftp/files/configdb.sql</code> then run:
                  <pre class="bg-gray-100 p-2 rounded text-sm whitespace-pre-wrap"><code>psql idautodb idautoAdmin &lt; /var/sftp/files/configdb.sql
system rapididentity stop
system rapididentity start</code></pre>
                </li>
              </ol>
            </div>
          </details>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.4 Install File Server</h3>
          <p>In the terminal UI select File Server and install. If prompted set a password.</p>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.5 Pre cutover checks</h3>
          <p>Confirm every new appliance will start and join the cluster. Check logs or disable SSO in rapididentity.properties to log in. In the UI you can verify at Configuration > Systems > Cluster. Look for Successfully join cluster or the license sequence in logs.</p>
        </div>

        <div class="space-y-4">
          <h3 class="text-lg font-semibold">2.6 Transfer IPs</h3>
          <ol class="list-decimal list-inside space-y-2 pl-4">
            <li>If supported by the hypervisor, disable the NIC on each old appliance.</li>
            <li>Shutdown old appliances in the order ARMS, DSS, DB.</li>
            <li>Assign production IPs to the new appliances.</li>
            <li>Update the hosts file line on each new appliance to map idautodb to the production DB ip.</li>
            <li>Start new appliances in the order DB, DSS, ARMS and Portal.</li>
          </ol>
        </div>
      </section>

      <section id="validation" class="space-y-6">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">3.</span> Validation and upgrades
        </h2>
        <ol class="list-decimal list-inside space-y-3 pl-4">
          <li>Portal and Connect load and allow login.</li>
          <li>Run representative workflows and check logs on all nodes.</li>
          <li>DNS or production IPs resolve to the new appliances.</li>
          <li>Snapshot the new appliances.</li>
          <li>Go to Configuration > System > Updates > Custom Update and enter:
            <div class="mt-2">
              <div class="grid grid-cols-1 gap-2">
                <div class="flex items-start gap-2"><span class="w-28 font-medium">Filename</span><span>rapididentity-2020.1.5-7597.zip</span></div>
                <div class="flex items-start gap-2"><span class="w-28 font-medium">Timestamp</span><span>2021-01-25T18:42:02.291Z</span></div>
                <div class="flex items-start gap-2"><span class="w-28 font-medium">Checksum</span><span class="break-all">35dac1d2f77aacc8aded892cc7e50330e739a855</span></div>
              </div>
            </div>
          </li>
          <li>Snapshot again and choose the 2025 release.</li>
          <li>After the 2025 upgrade completes and is stable take a final post migration snapshot.</li>
        </ol>
      </section>

      <section id="troubleshooting" class="space-y-6 pb-16">
        <h2 class="text-xl font-semibold text-sky-700 flex items-center">
          <span class="mr-2">4.</span> Troubleshooting and quick commands
        </h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h3 class="font-semibold mb-2">Common issues</h3>
            <ul class="list-disc list-inside space-y-2">
              <li>CLI shows DB running but Postgres is not installed. Roll back the appliances and run the DB Fix step then the migration script.</li>
              <li>Routing or mask issues. Correct the mask and retest.</li>
              <li>SSO loops. Disable SSO in rapididentity.properties and restart RI.</li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold mb-2">Cheat sheet</h3>
            <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>service rapididentity stop
service rapididentity start
psql idautodb idautoAdmin -t -A -c "show server_version; show server_version_num;"</code></pre>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-sky-700 text-white text-sm py-4">
      <div class="max-w-7xl mx-auto px-4 text-center">
        RapidIdentity Migration Guide
      </div>
    </footer>
  </body>
</html>
